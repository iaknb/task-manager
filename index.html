<!DOCTYPE html>
<html>

<head>
  <title>Aplikacja do zarządzania zadaniami</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="container">
    <div class="tasks">
      <h1>Lista zadań</h1>
      <div id="task-list"></div>
    </div>
    <div class="status">
      <div class="change-status">
        <h2>Wybierz projekt</h2>
        <select id="project-select"></select>
      </div>
      <div class="choose-task">
        <h2>Zmiana statusu zadania</h2>
        <p>Wybierz zadanie:</p>
        <select id="task-select">Brak zadań</select>
      </div>
      <div class="button">
        <button id="change-status-btn">Zmień status na "in_progress"</button>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
      $.get("/projects", function (projects) {
          projects.forEach(function (project) {
            let projectItem = $("<li><strong>Projekt:</strong> " + project.name + " (ID: " + project.id + ")</li>");
            let tasksList = $("<ul></ul>");

            $.get("/tasks/" + project.id, function (tasks) {
              if (tasks.length > 0) {
                tasks.forEach(function (task) {
                  tasksList.append("<li>" + task.name + " (Użytkownik: " + task.user_name + ")" + " Status zadania: " + task.status + "</li>");
                });
              } else {
                tasksList.append("<li>Brak zadań</li>");
              }

              projectItem.append(tasksList);
              $("#task-list").append(projectItem);
            });
          });
        $.get("/users", function (users) {
          users.forEach(function (user) {
            let userItem = $("<li>" + user.name + " " + user.last_name + "</li>");
            $("#user-list").append(userItem);
          });
        });
        projects.forEach(function (project) {
          let option = $("<option></option>").val(project.id).text(project.name);
          $("#project-select").append(option);
        });
      });
      $("#change-status-btn").click(function () {
        const projectId = $("#project-select").val();

        const taskId = $("#task-select").val();
        const status = "in_progress"; 


        $.post("/tasks/status", { projectId: projectId, taskId: taskId, status: status }, function (response) {

          alert("Status zadania został zmieniony na 'in_progress'");

        });
      });


      $("#project-select").change(function () {
        const projectId = $(this).val();

        $.get("/tasks/" + projectId, function (tasks) {

          $("#task-select").empty();

          if (tasks.length > 0) {
            tasks.forEach(function (task) {
              let option = $("<option></option>").val(task.id).text(task.name);
              $("#task-select").append(option);
            });
          } else {
            let option = $("<option disabled selected>Brak zadań</option>");
            $("#task-select").append(option);
          }
        });
      });
    });
  </script>
</body>

</html>